(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[780],{2703:function(e,n,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/learn/m4-backend",function(){return s(7891)}])},7891:function(e,n,s){"use strict";s.r(n);var r=s(5250),i=s(154),a=s(7160);s(425);var l=s(2766);function t(e){let n=Object.assign({h1:"h1",p:"p",a:"a",h2:"h2",ul:"ul",li:"li",h3:"h3",pre:"pre",code:"code",span:"span"},(0,a.ah)(),e.components);return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{children:"Module 4: Backend"}),"\n",(0,r.jsxs)(n.p,{children:["Green Boost (GB) uses ",(0,r.jsx)(n.a,{href:"https://nodejs.org/en",children:"Node.js"})," as it's JavaScript server side runtime, ",(0,r.jsx)(n.a,{href:"https://zod.dev/",children:"Zod"})," for schema validation, and ",(0,r.jsx)(n.a,{href:"https://orm.drizzle.team/",children:"Drizzle"})," as an ORM and automatic migration generator."]}),"\n",(0,r.jsx)(n.h2,{id:"learn",children:"Learn"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Node.js: read docs on ",(0,r.jsx)(n.a,{href:"https://nodejs.dev/en/learn/",children:"Getting Started"}),", ",(0,r.jsx)(n.a,{href:"https://nodejs.dev/en/learn/asynchronous-flow-control/",children:"Asynchronous Work"}),", ",(0,r.jsx)(n.a,{href:"https://nodejs.dev/en/learn/nodejs-file-stats/",children:"Manipulating Files"}),", and ",(0,r.jsx)(n.a,{href:"https://nodejs.dev/en/learn/run-nodejs-scripts-from-the-command-line/",children:"Command Line"})]}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html",children:"Lambda Best Practices"})}),"\n",(0,r.jsxs)(n.li,{children:["Zod: scan ",(0,r.jsx)(n.a,{href:"https://zod.dev/",children:"docs"})]}),"\n",(0,r.jsxs)(n.li,{children:["Drizzle: scan ",(0,r.jsx)(n.a,{href:"https://orm.drizzle.team/docs/quick-start",children:"Drizzle ORM docs"})," and ",(0,r.jsx)(n.a,{href:"https://orm.drizzle.team/kit-docs/overview",children:"Drizzle Kit docs"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"apply",children:"Apply"}),"\n",(0,r.jsx)(n.h3,{id:"m41---db-port-forwarding",children:"M4.1 - DB Port Forwarding"}),"\n",(0,r.jsx)(n.p,{children:"The Aurora PostgreSQL GB template runs a DB instance in the AWS Cloud, but how can you connect to it when developing? There are several options, but we'll use SSM Session Manager Port Forwarding. In order to do so, follow these steps:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["You should already have the AWS CLI installed by following the ",(0,r.jsx)(n.a,{href:"../overview/prereqs",children:"prerequisites"})]}),"\n",(0,r.jsxs)(n.li,{children:["Install the Session Manager Plugin for the AWS CLI with the following commands from ",(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager-working-with-install-plugin.html",children:"here"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{"data-language":"bash","data-theme":"default",children:(0,r.jsxs)(n.code,{"data-language":"bash","data-theme":"default",children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"curl"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"https://s3.amazonaws.com/session-manager-downloads/plugin/latest/mac/sessionmanager-bundle.zip"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"-o"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"sessionmanager-bundle.zip"'})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"unzip"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"sessionmanager-bundle.zip"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"sudo"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"./sessionmanager-bundle/install"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"-i"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"/usr/local/sessionmanagerplugin"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"-b"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"/usr/local/bin/session-manager-plugin"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"session-manager-plugin"})})]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["In order to forward the port from our DB to our local machine, we need a ",(0,r.jsx)(n.a,{href:"https://www.strongdm.com/what-is/bastion-host#:~:text=A%20bastion%20host%20is%20a,to%20reduce%20their%20attack%20surface.",children:"bastion host"}),". This has already been created for you in the template. Next, we'll need 3 environment variables: ",(0,r.jsx)(n.code,{children:"DB_BASTION_ID"})," and ",(0,r.jsx)(n.code,{children:"DB_ENDPOINT"}),". All of these values are exported by your CloudFormation templates and therefore were printed to your terminal when deploying the web app so you can find the values by scanning the logs or by going to the AWS Console. Instructions to find these values in the console are below.","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["DB_BASTION_ID: EC2 > Instances (running) > row with ",(0,r.jsx)(n.code,{children:"<stageName>-ssm-db-bastion"})," Name > Instance ID (starts with ",(0,r.jsx)(n.code,{children:"i-"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["DB_ENDPOINT: RDS > DB Instances > Select the regional cluster with a DB Identifier like ",(0,r.jsx)(n.code,{children:"<appId>-<stageName>-data-..."})," > Endpoints > Write instance endpoint (ends with ",(0,r.jsx)(n.code,{children:"rds.amazonaws.com"}),")"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["Export those environment variables in your shell or persist them in your .envrc file (learn more ",(0,r.jsx)(n.a,{href:"../overview/guides/aws-credentials#direnv",children:"here"}),")"]}),"\n",(0,r.jsxs)(n.li,{children:["Within ",(0,r.jsx)(n.code,{children:"core/"})," folder, run: ",(0,r.jsx)(n.span,{"data-rehype-pretty-code-fragment":"",children:(0,r.jsx)(n.code,{"data-language":"bash","data-theme":"default",children:(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"pnpm"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string)"},children:"db:connect"})]})})})]}),"\n",(0,r.jsx)(n.li,{children:'You should now see "Waiting for connections...". This means a port from your DB is being forwarded through your DB bastion to your local machine!'}),"\n"]}),"\n",(0,r.jsx)(l.UW,{type:"info",children:(0,r.jsx)(n.p,{children:"The default timeout of SSM Session Manager is 20 minutes. You may find this annoying. You can increase the timeout up to 60 minutes in the AWS Console by going to Systems Manager > Session Manager > Preferences > Edit > Idle session timeout"})}),"\n",(0,r.jsx)(n.h3,{id:"m42---db-gui",children:"M4.2 - DB GUI"}),"\n",(0,r.jsxs)(n.p,{children:["With port forwarding setup, you can now visualize your DB with a GUI like ",(0,r.jsx)(n.a,{href:"https://www.pgadmin.org/",children:"pgAdmin"}),". Below are steps for setting up pgAdmin, but you're welcome to use another DB GUI of your choice"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Install pgAdmin"}),"\n",(0,r.jsx)(n.li,{children:"Right click on Servers in the Object Explorer. Then select Register > Server."}),"\n",(0,r.jsxs)(n.li,{children:["General tab: Name: ",(0,r.jsx)(n.code,{children:"<appId>-<stageName>"})]}),"\n",(0,r.jsxs)(n.li,{children:["Connection tab: Host name/address: ",(0,r.jsx)(n.code,{children:"0.0.0.0"}),", Username: ",(0,r.jsx)(n.code,{children:"<appId>_admin"}),", Password: retrieve from Secrets Manager with steps below, Save password?: yes","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["AWS Console > Secrets Manager > Select secret with Description: ",(0,r.jsx)(n.code,{children:"Generated by the CDK for the stack: <appId>-<stageName>-data"})," > Secret Value Card > click Retrieve secret value button > copy Secret value of Secret key of password"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.li,{children:"Click save."}),"\n",(0,r.jsxs)(n.li,{children:["Then drill into your DB Server to view tables: ",(0,r.jsx)(n.code,{children:"<appId>-<stageName>"})," > Databases > ",(0,r.jsx)(n.code,{children:"<appId>_db"})," > Schemas > ",(0,r.jsx)(n.code,{children:"<appId>"})," > Tables"]}),"\n",(0,r.jsxs)(n.li,{children:["Right click on ",(0,r.jsx)(n.code,{children:"item"}),' table and then select "View/Edit Data" > All Rows']}),"\n",(0,r.jsx)(n.li,{children:"Now you can visualize your data locally as you develop"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"m43---create-a-new-album-table",children:"M4.3 - Create a New Album Table"}),"\n",(0,r.jsxs)(n.p,{children:["Next, we'll create a new table in our DB that will store albums supporting the feature we began working on in ",(0,r.jsx)(n.a,{href:"./m2-js-ts",children:"module 2"}),"."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Define the album table in ",(0,r.jsx)(n.code,{children:"core/src/modules/album/album.db.ts"})," following the requirements specified in module 2. You can use ",(0,r.jsx)(n.code,{children:"core/src/modules/item/item.db.ts"})," to help you."]}),"\n",(0,r.jsx)(n.li,{children:"With our table defined, how do we translate this definition into SQL code to update our DB? This is where Drizzle comes in as you learned above."}),"\n",(0,r.jsxs)(n.li,{children:["To generate the SQL to update our DB an albums table we'll run ",(0,r.jsx)(n.code,{children:"pnpm db:generate"}),". But first, we need to set the environment variable ",(0,r.jsx)(n.code,{children:"DB_SECRET_ARN"}),". You can find this value in the AWS Console on the same screen you retrieved the secret."]}),"\n",(0,r.jsxs)(n.li,{children:["Within ",(0,r.jsx)(n.code,{children:"core/"}),", run: ",(0,r.jsx)(n.code,{children:"pnpm db:generate"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Now you should see a new migration file generated at ",(0,r.jsx)(n.code,{children:"core/src/db/drizzle/"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Next, we'll migrate our DB to include the album table. Run: ",(0,r.jsx)(n.code,{children:"pnpm db:migrate"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Refresh the tables in your DB GUI and now you should see the ",(0,r.jsx)(n.code,{children:"album"})," table!"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"m44---refactor-crud-use-cases",children:"M4.4 - Refactor CRUD Use Cases"}),"\n",(0,r.jsxs)(n.p,{children:["With the album DB table ready to be used, now you'll need to refactor the use case functions you created in ",(0,r.jsx)(n.a,{href:"./m2-js-ts",children:"module 2"})," to use the actual DB instead of the JSONPlaceholder API. Don't worry about using the file layout pattern for the item module, you can include all related code in the ",(0,r.jsx)(n.code,{children:"<action>.usecase.ts"})," files. We'll refactor the use cases in ",(0,r.jsx)(n.a,{href:"./m7-clean-code",children:"module 7"}),". Make sure to export your use case functions from ",(0,r.jsx)(n.code,{children:"core/src/modules/album/index.ts"})," as we'll be using these functions in the next module."]}),"\n",(0,r.jsx)(n.h2,{id:"bonus",children:"Bonus"}),"\n",(0,r.jsx)(n.h3,{id:"m45---create-a-daily-album-summary-notification-lambda-function",children:"M4.5 - Create a Daily Album Summary Notification Lambda Function"}),"\n",(0,r.jsx)(n.p,{children:"Now we've been asked to deliver daily emails to an administrator with the number of albums in the table. First, we need to create a lambda function."}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Create the file: ",(0,r.jsx)(n.code,{children:"core/src/adapters/primary/album-summary-handler.ts"})," with the below template:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{"data-language":"ts","data-theme":"default",filename:"album-summary-handler.ts",children:(0,r.jsxs)(n.code,{"data-language":"ts","data-theme":"default",children:[(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"import"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"type"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" { EventBridgeHandler } "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"from"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"aws-lambda"'}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:" "}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"export"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"const"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-function)"},children:"handler"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" () "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-keyword)"},children:"=>"}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,r.jsxs)(n.span,{className:"line",children:[(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:"  "}),(0,r.jsx)(n.span,{style:{color:"var(--shiki-token-comment)"},children:"// TODO: add code here to get count of rows in album table"})]}),"\n",(0,r.jsx)(n.span,{className:"line",children:(0,r.jsx)(n.span,{style:{color:"var(--shiki-color-text)"},children:"};"})})]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"To test it, let's run it locally by adding the below code:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{"data-language":"ts","data-theme":"default",filename:"album-summary-handler.ts",children:(0,r.jsx)(n.code,{"data-language":"ts","data-theme":"default",children:(0,r.jsx)(n.span,{className:"line",children:" "})})}),"\n",(0,r.jsx)(n.h3,{id:"m46---create-eventbridge-rule",children:"M4.6 - Create EventBridge Rule"}),"\n",(0,r.jsx)(n.p,{children:"TODO"}),"\n",(0,r.jsx)(n.h3,{id:"m47-setup-email-with-ses",children:"M4.7 Setup Email with SES"})]})}n.default=(0,i.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,a.ah)(),e.components);return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(t,{...e})}):t(e)},pageOpts:{filePath:"src/pages/learn/m4-backend.mdx",route:"/learn/m4-backend",headings:[{depth:1,value:"Module 4: Backend",id:"module-4-backend"},{depth:2,value:"Learn",id:"learn"},{depth:2,value:"Apply",id:"apply"},{depth:3,value:"M4.1 - DB Port Forwarding",id:"m41---db-port-forwarding"},{depth:3,value:"M4.2 - DB GUI",id:"m42---db-gui"},{depth:3,value:"M4.3 - Create a New Album Table",id:"m43---create-a-new-album-table"},{depth:3,value:"M4.4 - Refactor CRUD Use Cases",id:"m44---refactor-crud-use-cases"},{depth:2,value:"Bonus",id:"bonus"},{depth:3,value:"M4.5 - Create a Daily Album Summary Notification Lambda Function",id:"m45---create-a-daily-album-summary-notification-lambda-function"},{depth:3,value:"M4.6 - Create EventBridge Rule",id:"m46---create-eventbridge-rule"},{depth:3,value:"M4.7 Setup Email with SES",id:"m47-setup-email-with-ses"}],title:"Module 4: Backend"},pageNextRoute:"/learn/m4-backend"})}},function(e){e.O(0,[154,774,888,179],function(){return e(e.s=2703)}),_N_E=e.O()}]);